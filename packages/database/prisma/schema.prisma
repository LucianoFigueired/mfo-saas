generator client {
  provider = "prisma-client-js"
  // output   = "../generated/client"             // Descomentar em produção
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  ADVISOR
  USER
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  name     String?
  role     UserRole @default(USER)

  clients Client[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Client {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  birthDate DateTime

  advisorId String
  advisor   User   @relation(fields: [advisorId], references: [id])

  simulations Simulation[]
  dependents  Dependent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("clients")
}

model Dependent {
  id        String   @id @default(uuid())
  name      String
  birthDate DateTime
  relation  String

  client   Client? @relation(fields: [clientId], references: [id])
  clientId String?

  @@map("dependents")
}

enum Relation {
  PARENTE
  FILHO
  CONJUGE
}

model Simulation {
  id          String   @id @default(uuid())
  name        String
  description String?
  baseTax     Decimal  @db.Decimal(10, 4)
  startDate   DateTime
  status      Status   @default(VIVO)

  aiAnalyses AiAnalysis[]

  isLegacy        Boolean @default(false)
  version         Int     @default(1)
  parentVersionId String?

  client   Client? @relation(fields: [clientId], references: [id])
  clientId String?

  assets     Asset[]
  events     Event[]
  insurances Insurance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiAnalysis {
  id          String @id @default(uuid())
  summary     String @db.Text
  risks       Json // Lista de strings ou objetos
  suggestions Json // Lista de sugestões estruturadas
  rawResponse Json? // Guardar o JSON bruto da OpenAI para debug

  simulationId String
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum Status {
  VIVO
  MORTO
  INVALIDO
}

model Asset {
  id    String    @id @default(uuid())
  name  String
  type  AssetType
  value Decimal   @db.Decimal(15, 2)
  date  DateTime

  // Para bens imobilizados/financiados
  isFinanced   Boolean  @default(false)
  installments Int?
  interestRate Decimal? @db.Decimal(10, 4)
  downPayment  Decimal? @db.Decimal(15, 2)

  simulationId String
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
}

enum AssetType {
  FINANCEIRO
  IMOBILIZADO
}

model Event {
  id        String    @id @default(uuid())
  name      String
  type      EventType
  value     Decimal   @db.Decimal(15, 2)
  frequency Frequency @default(ONCE)
  startDate DateTime
  endDate   DateTime?

  simulationId String
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
}

enum EventType {
  ENTRADA
  SAIDA
}

enum Frequency {
  ONCE
  MONTHLY
  YEARLY
}

model Insurance {
  id           String   @id @default(uuid())
  name         String
  premium      Decimal  @db.Decimal(15, 2) // Valor mensal pago
  insuredValue Decimal  @db.Decimal(15, 2) // Valor a receber
  duration     Int // Em meses
  startDate    DateTime

  simulationId String
  simulation   Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
}
